<!doctype html>
<html lang="en" data-vocs>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/initializeTheme.iife.js"></script><link rel="preload" as="image" href="/images/jincubator.png"/><title>Horizon Bridge – John Whitton</title><link rel="icon" href="/images/jincubator.png" type="image/png"/><meta property="og:type" content="website"/><meta property="og:title" content="Horizon Bridge"/><meta property="og:image" content="https://vocs.dev/api/og?logo=/images/jincubator.png&title=Horizon Bridge&description="/><meta name="twitter:card" content="summary_large_image"/><meta property="twitter:image" content="https://vocs.dev/api/og?logo=/images/jincubator.png&title=Horizon%20Bridge&description=undefined"/>
    <script type="module" crossorigin src="/assets/index-Bh7sFfRs.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/style-Cs3UkTB6.css">
  </head>
  <body>
    <div id="app"><div class="vocs_DocsLayout" data-layout="docs"><a class="vocs_SkipLink vocs_utils_visuallyHidden" href="/research/code/horizon#vocs-content">Skip to content</a><div class="vocs_DocsLayout_gutterLeft"><aside class="vocs_Sidebar vocs_DocsLayout_sidebar"><div><div class="vocs_Sidebar_logoWrapper"><div class="vocs_Sidebar_logo"><a style="align-items:center;display:flex;height:100%" href="/" data-discover="true"><img alt="Logo" class="vocs_NavLogo_logoImage vocs_Logo" src="/images/jincubator.png"/></a></div><div class="vocs_Sidebar_divider"></div></div><nav class="vocs_Sidebar_navigation"><div class="vocs_Sidebar_group"><section class="vocs_Sidebar_section"><div class="vocs_Sidebar_items"><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/intro" variant="styleless" data-discover="true">John&#x27;s Research</a></div></section><section class="vocs_Sidebar_section vocs_Sidebar_level"><div class="vocs_Sidebar_sectionHeader"><div class="vocs_Sidebar_sectionTitle">Primitives</div></div><div class="vocs_Sidebar_items"><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/primitives/intro" variant="styleless" data-discover="true">Primitives Intro</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/primitives/fraud-proofs" variant="styleless" data-discover="true">Fraud Proofs</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/primitives/light-clients" variant="styleless" data-discover="true">Light Clients</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/primitives/primitives" variant="styleless" data-discover="true">Cryptogaphic Primitives</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/primitives/weak-subjectivity" variant="styleless" data-discover="true">Weak Subjectivity</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/primitives/signatures" variant="styleless" data-discover="true">Signature Schemes</a></div></section><section class="vocs_Sidebar_section vocs_Sidebar_level"><div class="vocs_Sidebar_sectionHeader"><div class="vocs_Sidebar_sectionTitle">Zero Knowledge</div></div><div class="vocs_Sidebar_items"><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/zk/intro" variant="styleless" data-discover="true">Zero Knowledge Intro</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/zk/zkpos" variant="styleless" data-discover="true">ZK Proof of Stake</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/zk/zksnarks" variant="styleless" data-discover="true">zk-Snarks</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/zk/axiom" variant="styleless" data-discover="true">Axiom</a></div></section><section class="vocs_Sidebar_section vocs_Sidebar_level"><div class="vocs_Sidebar_sectionHeader"><div class="vocs_Sidebar_sectionTitle">Cross Chain Bridges</div></div><div class="vocs_Sidebar_items"><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/bridge/intro" variant="styleless" data-discover="true">Bridging Intro</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/bridge/cosmos-ibc" variant="styleless" data-discover="true">Cosmos IBC</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/bridge/harmony-horizon" variant="styleless" data-discover="true">Harmony Horizon</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/bridge/isomorph" variant="styleless" data-discover="true">Isomorph</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/bridge/near-rainbow" variant="styleless" data-discover="true">Near Rainbow Bridge</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/bridge/polymerlabs" variant="styleless" data-discover="true">Polymer Labs</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/bridge/snowbridge" variant="styleless" data-discover="true">Snowbridge</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/bridge/succinct" variant="styleless" data-discover="true">Succint</a></div></section><section class="vocs_Sidebar_section vocs_Sidebar_level"><div class="vocs_Sidebar_sectionHeader"><div class="vocs_Sidebar_sectionTitle">Layer 1 Platforms</div></div><div class="vocs_Sidebar_items"><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/chains/intro" variant="styleless" data-discover="true">Layer 1 Intro</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/chains/avalanche" variant="styleless" data-discover="true">Avalanche</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/chains/binance" variant="styleless" data-discover="true">Binance Smart Chain</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/chains/cosmos" variant="styleless" data-discover="true">Cosmos</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/chains/ethereum-1-0" variant="styleless" data-discover="true">Ethereum 1.0</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/chains/ethereum" variant="styleless" data-discover="true">Ethereum</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/chains/harmony" variant="styleless" data-discover="true">Harmony</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/chains/polkadot" variant="styleless" data-discover="true">Polkadot</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/chains/polygon" variant="styleless" data-discover="true">Polygon</a></div></section><section class="vocs_Sidebar_section vocs_Sidebar_level"><div class="vocs_Sidebar_sectionHeader"><div class="vocs_Sidebar_sectionTitle">Code Reviews</div></div><div class="vocs_Sidebar_items"><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/code/intro" variant="styleless" data-discover="true">Code Review Intro</a><a data-active="true" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/code/horizon" variant="styleless" data-discover="true">Horizon Bridge</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/code/ethereum-near" variant="styleless" data-discover="true">Ethereum Near Bridge</a><a data-active="false" class="vocs_Sidebar_item vocs_Link vocs_Link_styleless" href="/research/code/ethereum" variant="styleless" data-discover="true">Ethereum</a></div></section></div></nav></div><div class="vocs_Sidebar_footer"><div class="vocs_Sidebar_footerCurtain"></div><div class="vocs_Sidebar_footerContent"><div class="vocs_Socials"><a class="vocs_Socials_button" href="https://github.com/johnwhitton" target="_blank" rel="noopener noreferrer"><div aria-label="GitHub" class="vocs_Icon vocs_Socials_icon" role="img" style="--vocs_Icon_size:17px"><svg width="100%" height="100%" viewBox="0 0 98 96" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z" fill="currentColor"></path></svg></div></a><div style="width:1px;margin-top:var(--vocs-space_4);margin-bottom:var(--vocs-space_4);background-color:var(--vocs-color_border)"></div><a class="vocs_Socials_button" href="https://twitter.com/johnwhitton" target="_blank" rel="noopener noreferrer"><div aria-label="X (Twitter)" class="vocs_Icon vocs_Socials_icon" role="img" style="--vocs_Icon_size:16px"><svg width="100%" height="100%" viewBox="0 0 1200 1227" fill="none" xmlns="http://www.w3.org/2000/svg"><title>X</title><path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z" fill="currentColor"></path></svg></div></a><div style="width:1px;margin-top:var(--vocs-space_4);margin-bottom:var(--vocs-space_4);background-color:var(--vocs-color_border)"></div><a class="vocs_Socials_button" href="https://t.me/john_whitton" target="_blank" rel="noopener noreferrer"><div aria-label="Telegram" class="vocs_Icon vocs_Socials_icon" role="img" style="--vocs_Icon_size:17px"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 50 50"><title>Telegram</title><path d="M25 2c12.703 0 23 10.297 23 23S37.703 48 25 48 2 37.703 2 25 12.297 2 25 2zm7.934 32.375c.423-1.298 2.405-14.234 2.65-16.783.074-.772-.17-1.285-.648-1.514-.578-.278-1.434-.139-2.427.219-1.362.491-18.774 7.884-19.78 8.312-.954.405-1.856.847-1.856 1.487 0 .45.267.703 1.003.966.766.273 2.695.858 3.834 1.172 1.097.303 2.346.04 3.046-.395.742-.461 9.305-6.191 9.92-6.693.614-.502 1.104.141.602.644-.502.502-6.38 6.207-7.155 6.997-.941.959-.273 1.953.358 2.351.721.454 5.906 3.932 6.687 4.49.781.558 1.573.811 2.298.811.725 0 1.107-.955 1.468-2.064z" fill="currentColor"></path></svg></div></a></div></div></div></aside></div><div class="vocs_DocsLayout_gutterTop vocs_DocsLayout_gutterTop_offsetLeftGutter"><div class="vocs_DesktopTopNav"><button class="vocs_DesktopSearch_search" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-«Rlj»" data-state="closed"><svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-top:2px"><path d="M10 6.5C10 8.433 8.433 10 6.5 10C4.567 10 3 8.433 3 6.5C3 4.567 4.567 3 6.5 3C8.433 3 10 4.567 10 6.5ZM9.30884 10.0159C8.53901 10.6318 7.56251 11 6.5 11C4.01472 11 2 8.98528 2 6.5C2 4.01472 4.01472 2 6.5 2C8.98528 2 11 4.01472 11 6.5C11 7.56251 10.6318 8.53901 10.0159 9.30884L12.8536 12.1464C13.0488 12.3417 13.0488 12.6583 12.8536 12.8536C12.6583 13.0488 12.3417 13.0488 12.1464 12.8536L9.30884 10.0159Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>Search...<div class="vocs_DesktopSearch_searchCommand"><div style="background:currentColor;transform:rotate(45deg);width:1.5px;border-radius:2px;height:100%"></div></div></button><div class="vocs_DesktopTopNav_logoWrapper"><div class="vocs_DesktopTopNav_logo"><a style="align-items:center;display:flex;height:56px;margin-top:4px" href="/" data-discover="true"><img alt="Logo" class="vocs_NavLogo_logoImage vocs_Logo" src="/images/jincubator.png"/></a></div></div><div class="vocs_DesktopTopNav_section"></div><div class="vocs_DesktopTopNav_section"><div class="vocs_DesktopTopNav_group"><nav aria-label="Main" data-orientation="horizontal" dir="ltr" class="vocs_NavigationMenu"><div style="position:relative"><ul data-orientation="horizontal" class="vocs_NavigationMenu_list" dir="ltr"><a data-active="true" class="vocs_DesktopTopNav_item vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/" variant="styleless" data-radix-collection-item="" data-discover="true">Home</a><a data-active="false" class="vocs_DesktopTopNav_item vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/about" variant="styleless" data-radix-collection-item="" data-discover="true">About John</a><a data-active="false" class="vocs_DesktopTopNav_item vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/resume" variant="styleless" data-radix-collection-item="" data-discover="true">Resume</a><a data-active="false" class="vocs_DesktopTopNav_item vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/references" variant="styleless" data-radix-collection-item="" data-discover="true">References</a><a data-active="false" class="vocs_DesktopTopNav_item vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/writing/intro" variant="styleless" data-radix-collection-item="" data-discover="true">Writing</a><a data-active="false" class="vocs_DesktopTopNav_item vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/research/intro" variant="styleless" data-radix-collection-item="" data-discover="true">Research</a></ul></div></nav></div></div></div><div class="vocs_MobileTopNav"><div class="vocs_MobileTopNav_section"><div class="vocs_MobileTopNav_group"><div class="vocs_MobileTopNav_logo"><a style="align-items:center;display:flex;height:100%" href="/" data-discover="true"><img alt="Logo" class="vocs_NavLogo_logoImage vocs_Logo" src="/images/jincubator.png"/></a></div></div><div class="vocs_MobileTopNav_group"><nav aria-label="Main" data-orientation="horizontal" dir="ltr" class="vocs_MobileTopNav_navigation vocs_NavigationMenu"><div style="position:relative"><ul data-orientation="horizontal" class="vocs_NavigationMenu_list" dir="ltr"><a data-active="true" class="vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/" variant="styleless" data-radix-collection-item="" data-discover="true">Home</a><a data-active="false" class="vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/about" variant="styleless" data-radix-collection-item="" data-discover="true">About John</a><a data-active="false" class="vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/resume" variant="styleless" data-radix-collection-item="" data-discover="true">Resume</a><a data-active="false" class="vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/references" variant="styleless" data-radix-collection-item="" data-discover="true">References</a><a data-active="false" class="vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/writing/intro" variant="styleless" data-radix-collection-item="" data-discover="true">Writing</a><a data-active="false" class="vocs_NavigationMenu_link vocs_Link vocs_Link_styleless" href="/research/intro" variant="styleless" data-radix-collection-item="" data-discover="true">Research</a></ul></div></nav><div class="vocs_MobileTopNav_navigation vocs_MobileTopNav_navigation_compact"><button type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-«Rkpj»" data-state="closed" class="vocs_MobileTopNav_menuTrigger vocs_MobileTopNav_navigationItem">Home<div aria-label="Menu" class="vocs_Icon" role="img" style="--vocs_Icon_size:16px"><svg width="100%" height="100%" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><title>Chevron Down</title><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg></div></button></div></div></div><div class="vocs_MobileTopNav_section"><div class="vocs_MobileTopNav_group" style="margin-right:-8px"><button class="vocs_MobileSearch_searchButton" type="button" aria-label="Search" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-«R19j»" data-state="closed"><svg width="21" height="21" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 6.5C10 8.433 8.433 10 6.5 10C4.567 10 3 8.433 3 6.5C3 4.567 4.567 3 6.5 3C8.433 3 10 4.567 10 6.5ZM9.30884 10.0159C8.53901 10.6318 7.56251 11 6.5 11C4.01472 11 2 8.98528 2 6.5C2 4.01472 4.01472 2 6.5 2C8.98528 2 11 4.01472 11 6.5C11 7.56251 10.6318 8.53901 10.0159 9.30884L12.8536 12.1464C13.0488 12.3417 13.0488 12.6583 12.8536 12.8536C12.6583 13.0488 12.3417 13.0488 12.1464 12.8536L9.30884 10.0159Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg></button></div></div></div></div><div class="vocs_DocsLayout_gutterTopCurtain vocs_DocsLayout_gutterTopCurtain_withSidebar"><div class="vocs_DesktopTopNav_curtain"></div><div class="vocs_MobileTopNav_curtain"><div class="vocs_MobileTopNav_curtainGroup"><div class="vocs_MobileTopNav_curtainItem"><button type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-«Rqj»" data-state="closed" class="vocs_MobileTopNav_menuTrigger"><div aria-label="Menu" class="vocs_Icon" role="img" style="--vocs_Icon_size:13px"><svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 79 48" fill="none"><title>Menu</title><path fill="currentColor" d="M19.528 47.232h40.87c1.952 0 3.515-1.562 3.515-3.564a3.5 3.5 0 0 0-3.516-3.516H19.528a3.501 3.501 0 0 0-3.515 3.516c0 2.002 1.562 3.564 3.515 3.564ZM12.057 27.262h55.81a3.501 3.501 0 0 0 3.516-3.516 3.501 3.501 0 0 0-3.515-3.515h-55.81a3.501 3.501 0 0 0-3.516 3.515 3.501 3.501 0 0 0 3.515 3.516ZM4.391 7.34H75.29c2.002 0 3.515-1.563 3.515-3.516 0-2.002-1.513-3.564-3.515-3.564H4.39C2.438.26.876 1.822.876 3.824A3.501 3.501 0 0 0 4.39 7.34Z"></path></svg></div><div class="vocs_MobileTopNav_menuTitle">Horizon Bridge</div></button></div></div><div class="vocs_MobileTopNav_curtainGroup"><div class="vocs_MobileTopNav_curtainItem"><button type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-«R5aj»" data-state="closed" class="vocs_MobileTopNav_outlineTrigger">On this page<div aria-label="On this page" class="vocs_Icon" role="img" style="--vocs_Icon_size:16px"><svg width="100%" height="100%" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><title>Chevron Right</title><path d="M6.1584 3.13508C6.35985 2.94621 6.67627 2.95642 6.86514 3.15788L10.6151 7.15788C10.7954 7.3502 10.7954 7.64949 10.6151 7.84182L6.86514 11.8418C6.67627 12.0433 6.35985 12.0535 6.1584 11.8646C5.95694 11.6757 5.94673 11.3593 6.1356 11.1579L9.565 7.49985L6.1356 3.84182C5.94673 3.64036 5.95694 3.32394 6.1584 3.13508Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg></div></button></div></div></div></div><div class="vocs_DocsLayout_gutterRight vocs_DocsLayout_gutterRight_withSidebar"></div><div id="vocs-content" class="vocs_DocsLayout_content vocs_DocsLayout_content_withSidebar vocs_DocsLayout_content_withTopNav"><article class="vocs_Content"><header class="vocs_Header"><h1 class="vocs_H1 vocs_Heading"><div id="horizon-bridge" class="vocs_Heading_slugTarget"></div>Horizon Bridge<a class="vocs_Anchor vocs_Autolink" aria-hidden="true" tabindex="-1" href="/research/code/horizon#horizon-bridge" data-discover="true"><div data-autolink-icon="true" class="vocs_Div vocs_AutolinkIcon" style="--vocs_AutolinkIcon_iconUrl:url(/.vocs/icons/link.svg)"></div></a></h1></header>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">date: 2023-02-04</li>
<li class="vocs_ListItem">last updated: 2023-02-04</li>
</ul>
<h2 class="vocs_H2 vocs_Heading"><div id="overview" class="vocs_Heading_slugTarget"></div>Overview<a class="vocs_Anchor vocs_Autolink" aria-hidden="true" tabindex="-1" href="/research/code/horizon#overview" data-discover="true"><div data-autolink-icon="true" class="vocs_Div vocs_AutolinkIcon" style="--vocs_AutolinkIcon_iconUrl:url(/.vocs/icons/link.svg)"></div></a></h2>
<p class="vocs_Paragraph">This document reviews the <a class="vocs_Anchor vocs_Link vocs_Link_accent" href="https://github.com/johnwhitton/horizon/tree/refactorV2" target="_blank" rel="noopener noreferrer" style="--vocs_ExternalLink_iconUrl:url(/.vocs/icons/arrow-diagonal.svg)">horizon</a> current implementation, development tasks that need to be done to support POW and offers some thoughts on next steps to support Ethereum 2.0 and other chains.</p>
<p class="vocs_Paragraph">Further thoughts on ETH 2.0 support, removing the ETHHASH logic and SPV client and potentially replacing with MMR trees per epoch and checkpoints similar to Harmony Light Client on Ethereum, can be found <a class="vocs_Anchor vocs_Link vocs_Link_accent" href="/research/chains/ethereum" data-discover="true">here</a>.</p>
<h2 class="vocs_H2 vocs_Heading"><div id="next-steps" class="vocs_Heading_slugTarget"></div>Next Steps<a class="vocs_Anchor vocs_Autolink" aria-hidden="true" tabindex="-1" href="/research/code/horizon#next-steps" data-discover="true"><div data-autolink-icon="true" class="vocs_Div vocs_AutolinkIcon" style="--vocs_AutolinkIcon_iconUrl:url(/.vocs/icons/link.svg)"></div></a></h2>
<p class="vocs_Paragraph">Following are some of the improvements needed broken down by functional areas.</p>
<h3 class="vocs_H3 vocs_Heading"><div id="ethereum-light-client" class="vocs_Heading_slugTarget"></div>Ethereum Light Client<a class="vocs_Anchor vocs_Autolink" aria-hidden="true" tabindex="-1" href="/research/code/horizon#ethereum-light-client" data-discover="true"><div data-autolink-icon="true" class="vocs_Div vocs_AutolinkIcon" style="--vocs_AutolinkIcon_iconUrl:url(/.vocs/icons/link.svg)"></div></a></h3>
<ol class="vocs_List vocs_List_ordered">
<li class="vocs_ListItem">ETH 2.0 support see <a class="vocs_Anchor vocs_Link vocs_Link_accent" href="/research/chains/ethereum" data-discover="true">here</a></li>
<li class="vocs_ListItem">Queuing mechanism should be implemented to queue bridge transactions. The queue can be polled as part of the block relay functionality to process bridge transactions once the blocks have been relayed.</li>
<li class="vocs_ListItem">Consider whether we can use p2p messaging to receive published blocks rather than looping and polling via an RPC.</li>
</ol>
<h3 class="vocs_H3 vocs_Heading"><div id="harmony-light-client" class="vocs_Heading_slugTarget"></div>Harmony Light Client<a class="vocs_Anchor vocs_Autolink" aria-hidden="true" tabindex="-1" href="/research/code/horizon#harmony-light-client" data-discover="true"><div data-autolink-icon="true" class="vocs_Div vocs_AutolinkIcon" style="--vocs_AutolinkIcon_iconUrl:url(/.vocs/icons/link.svg)"></div></a></h3>
<ol class="vocs_List vocs_List_ordered">
<li class="vocs_ListItem">Needs to implement a process to <code class="vocs_Code">submitCheckpoint</code>.</li>
<li class="vocs_ListItem"><code class="vocs_Code">eprove</code> logic needs to be reviewed</li>
<li class="vocs_ListItem">Queuing mechanism should be implemented to queue bridge transactions. The queue can be polled as part of the <code class="vocs_Code">submitCheckpoint</code> functionality to process bridge transactions once the blocks have been relayed.</li>
<li class="vocs_ListItem">Need to facilitate the core protocol <a class="vocs_Anchor vocs_Link vocs_Link_accent" href="https://github.com/harmony-one/harmony/pull/4198/files" target="_blank" rel="noopener noreferrer" style="--vocs_ExternalLink_iconUrl:url(/.vocs/icons/arrow-diagonal.svg)">MMR enhancements PR</a></li>
</ol>
<h3 class="vocs_H3 vocs_Heading"><div id="transaction-sequencing" class="vocs_Heading_slugTarget"></div>Transaction Sequencing<a class="vocs_Anchor vocs_Autolink" aria-hidden="true" tabindex="-1" href="/research/code/horizon#transaction-sequencing" data-discover="true"><div data-autolink-icon="true" class="vocs_Div vocs_AutolinkIcon" style="--vocs_AutolinkIcon_iconUrl:url(/.vocs/icons/link.svg)"></div></a></h3>
<p class="vocs_Paragraph">Sequencing of Transactions: Needs to be implemented and <code class="vocs_Code">TokenMap</code> in <code class="vocs_Code">bridge.js</code> needs to be refactored. Below is the current sequence flow and areas for improvements.</p>
<ol class="vocs_List vocs_List_ordered">
<li class="vocs_ListItem">Ethereum Mapping Request</li>
<li class="vocs_ListItem">Relay of Block to EthereumLightClient.sol on Harmony<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">The block has to be relayed before we can process the Harmony Mapping request, as we have just executed the transaction the relayer usually has not relayed the block so this will fail.</li>
<li class="vocs_ListItem">There must be an additional 25 blocks on Ethereum before this block can be considered part of the canonical chain.</li>
<li class="vocs_ListItem">This logic needs to be rewritten to break down execution for 1. the ethereum mapping request 2. After a 25 block delay the Harmony Proof validation and executing the Harmony Mapping Request**</li>
</ul>
</li>
<li class="vocs_ListItem">Harmony Mapping Request</li>
<li class="vocs_ListItem">Relay of Checkpoint to HarmonyLightClient.sol on Ethereum<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">A <code class="vocs_Code">submitCheckpoint</code> in <code class="vocs_Code">HarmonyLightClient.sol</code> needs to have called either for the next epoch or for a checkpoint, after the block the harmony mapping transaction was in.**</li>
<li class="vocs_ListItem">Automatic submission of checkpoints to the Harmony Light Client has not been developed as yet. (It is not part of the <code class="vocs_Code">ethRelay.js</code>). And so the checkpoint would need to be manually submitted before the Ethereum Mapping could take place.</li>
</ul>
</li>
<li class="vocs_ListItem">Etherem Process Harmony Mapping Acknowledgement</li>
</ol>
<h3 class="vocs_H3 vocs_Heading"><div id="bridge-functionality" class="vocs_Heading_slugTarget"></div>Bridge Functionality<a class="vocs_Anchor vocs_Autolink" aria-hidden="true" tabindex="-1" href="/research/code/horizon#bridge-functionality" data-discover="true"><div data-autolink-icon="true" class="vocs_Div vocs_AutolinkIcon" style="--vocs_AutolinkIcon_iconUrl:url(/.vocs/icons/link.svg)"></div></a></h3>
<ol class="vocs_List vocs_List_ordered">
<li class="vocs_ListItem">Need to support mapping Harmony Tokens to Ethereum</li>
</ol>
<h3 class="vocs_H3 vocs_Heading"><div id="multichain-support" class="vocs_Heading_slugTarget"></div>MultiChain Support<a class="vocs_Anchor vocs_Autolink" aria-hidden="true" tabindex="-1" href="/research/code/horizon#multichain-support" data-discover="true"><div data-autolink-icon="true" class="vocs_Div vocs_AutolinkIcon" style="--vocs_AutolinkIcon_iconUrl:url(/.vocs/icons/link.svg)"></div></a></h3>
<ol class="vocs_List vocs_List_ordered">
<li class="vocs_ListItem">Need to support other chains<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">EVM: BSC, Polygon, Avalanche, Arbitrum, Optimism</li>
<li class="vocs_ListItem">Bitcoin</li>
<li class="vocs_ListItem">NEAR</li>
<li class="vocs_ListItem">Solana</li>
<li class="vocs_ListItem">Polkadot</li>
</ul>
</li>
<li class="vocs_ListItem">Links to initial Design thoughs including reviews of cross chain messaging protocols and other multichain bridges can be found in Multichain Trustless Bridge : Draft.</li>
</ol>
<h2 class="vocs_H2 vocs_Heading"><div id="current-implementation-walkthough" class="vocs_Heading_slugTarget"></div>Current Implementation Walkthough<a class="vocs_Anchor vocs_Autolink" aria-hidden="true" tabindex="-1" href="/research/code/horizon#current-implementation-walkthough" data-discover="true"><div data-autolink-icon="true" class="vocs_Div vocs_AutolinkIcon" style="--vocs_AutolinkIcon_iconUrl:url(/.vocs/icons/link.svg)"></div></a></h2>
<p class="vocs_Paragraph">Following is a detailed walk though of the current implementation of the Ethereum Light Client and the flow for mapping tokens from Ethereum to Harmony.</p>
<h2 class="vocs_H2 vocs_Heading"><div id="ethereum-light-client-on-harmony" class="vocs_Heading_slugTarget"></div>Ethereum Light Client (on Harmony)<a class="vocs_Anchor vocs_Autolink" aria-hidden="true" tabindex="-1" href="/research/code/horizon#ethereum-light-client-on-harmony" data-discover="true"><div data-autolink-icon="true" class="vocs_Div vocs_AutolinkIcon" style="--vocs_AutolinkIcon_iconUrl:url(/.vocs/icons/link.svg)"></div></a></h2>
<p class="vocs_Paragraph"><strong class="vocs_Strong">Design</strong>
Existing Design</p>
<ol class="vocs_List vocs_List_ordered">
<li class="vocs_ListItem">DAG is generated for each Ethereum EPOCH: This takes a couple of hours and has a size of approx 1GB.</li>
<li class="vocs_ListItem">Relayer is run to replicate each block header to the SPV Client on Harmony.</li>
<li class="vocs_ListItem">EthereumLightClient.sol addBlockHeader: Adds each block header to the Ethereum Light Client.</li>
<li class="vocs_ListItem">Transactions are Verified</li>
</ol>
<strong class="vocs_Strong">Running the Relayer</strong>
<div class="vocs_CodeBlock"><div class="vocs_Pre_wrapper"><pre style="background-color:#fff;--shiki-dark-bg:#22272e;color:#24292e;--shiki-dark:#adbac7" tabindex="0" class="shiki shiki-themes github-light github-dark-dimmed vocs_Pre"><button class="vocs_CopyButton" data-copied="false" type="button"><div aria-label="Copy" class="vocs_Icon" role="img" style="--vocs_Icon_size:18px"><svg width="100%" height="100%" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><title>Copy</title><path d="M5 2V1H10V2H5ZM4.75 0C4.33579 0 4 0.335786 4 0.75V1H3.5C2.67157 1 2 1.67157 2 2.5V12.5C2 13.3284 2.67157 14 3.5 14H7V13H3.5C3.22386 13 3 12.7761 3 12.5V2.5C3 2.22386 3.22386 2 3.5 2H4V2.25C4 2.66421 4.33579 3 4.75 3H10.25C10.6642 3 11 2.66421 11 2.25V2H11.5C11.7761 2 12 2.22386 12 2.5V7H13V2.5C13 1.67157 12.3284 1 11.5 1H11V0.75C11 0.335786 10.6642 0 10.25 0H4.75ZM9 8.5C9 8.77614 8.77614 9 8.5 9C8.22386 9 8 8.77614 8 8.5C8 8.22386 8.22386 8 8.5 8C8.77614 8 9 8.22386 9 8.5ZM10.5 9C10.7761 9 11 8.77614 11 8.5C11 8.22386 10.7761 8 10.5 8C10.2239 8 10 8.22386 10 8.5C10 8.77614 10.2239 9 10.5 9ZM13 8.5C13 8.77614 12.7761 9 12.5 9C12.2239 9 12 8.77614 12 8.5C12 8.22386 12.2239 8 12.5 8C12.7761 8 13 8.22386 13 8.5ZM14.5 9C14.7761 9 15 8.77614 15 8.5C15 8.22386 14.7761 8 14.5 8C14.2239 8 14 8.22386 14 8.5C14 8.77614 14.2239 9 14.5 9ZM15 10.5C15 10.7761 14.7761 11 14.5 11C14.2239 11 14 10.7761 14 10.5C14 10.2239 14.2239 10 14.5 10C14.7761 10 15 10.2239 15 10.5ZM14.5 13C14.7761 13 15 12.7761 15 12.5C15 12.2239 14.7761 12 14.5 12C14.2239 12 14 12.2239 14 12.5C14 12.7761 14.2239 13 14.5 13ZM14.5 15C14.7761 15 15 14.7761 15 14.5C15 14.2239 14.7761 14 14.5 14C14.2239 14 14 14.2239 14 14.5C14 14.7761 14.2239 15 14.5 15ZM8.5 11C8.77614 11 9 10.7761 9 10.5C9 10.2239 8.77614 10 8.5 10C8.22386 10 8 10.2239 8 10.5C8 10.7761 8.22386 11 8.5 11ZM9 12.5C9 12.7761 8.77614 13 8.5 13C8.22386 13 8 12.7761 8 12.5C8 12.2239 8.22386 12 8.5 12C8.77614 12 9 12.2239 9 12.5ZM8.5 15C8.77614 15 9 14.7761 9 14.5C9 14.2239 8.77614 14 8.5 14C8.22386 14 8 14.2239 8 14.5C8 14.7761 8.22386 15 8.5 15ZM11 14.5C11 14.7761 10.7761 15 10.5 15C10.2239 15 10 14.7761 10 14.5C10 14.2239 10.2239 14 10.5 14C10.7761 14 11 14.2239 11 14.5ZM12.5 15C12.7761 15 13 14.7761 13 14.5C13 14.2239 12.7761 14 12.5 14C12.2239 14 12 14.2239 12 14.5C12 14.7761 12.2239 15 12.5 15Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg></div></button><code class="vocs_Code"><span class="line vocs_Span"><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span"># Start the relayer (note: replace the etherum light client address below)</span></span>
<span class="line vocs_Span"><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span"># relay [</span><span style="color:#032F62;text-decoration:underline;font-weight:inherit;--shiki-dark:#96D0FF;--shiki-dark-text-decoration:inherit;--shiki-dark-font-weight:bold" class="vocs_Span">options</span><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span">] &lt;</span><span style="color:#22863A;font-weight:bold;--shiki-dark:#8DDB8C;--shiki-dark-font-weight:bold" class="vocs_Span">ethUrl</span><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span">&gt; &lt;</span><span style="color:#22863A;font-weight:bold;--shiki-dark:#8DDB8C;--shiki-dark-font-weight:bold" class="vocs_Span">hmyUrl</span><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span">&gt; &lt;</span><span style="color:#22863A;font-weight:bold;--shiki-dark:#8DDB8C;--shiki-dark-font-weight:bold" class="vocs_Span">elcAddress</span><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span">&gt;   relay eth block header to elc on hmy</span></span>
<span class="line vocs_Span"><span style="color:#24292E;--shiki-dark:#ADBAC7" class="vocs_Span"> yarn cli ethRelay relay http://localhost:8645 http://localhost:9500 0x3Ceb74A902dc5fc11cF6337F68d04cB834AE6A22</span></span></code></pre></div></div>
<strong class="vocs_Strong">Implementation</strong>
<ol class="vocs_List vocs_List_ordered">
<li class="vocs_ListItem">DAG Generation can be done explicity by calling <code class="vocs_Code">dagProve</code> from the CLI or it is done automatically by <code class="vocs_Code">getHeaderProof</code> in <code class="vocs_Code">ethHashProof/BlockProof.js</code> which is called from <code class="vocs_Code">blockRelay</code> in <code class="vocs_Code">cli/ethRelay.js</code>.</li>
<li class="vocs_ListItem">Relaying of Block Headers is done by <code class="vocs_Code">blockRelayLoop</code> in <code class="vocs_Code">cli/ethRelay.js</code> which<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">Reads the last block header from EthereumLightClient.sol</li>
<li class="vocs_ListItem">Loops through calling an Ethereum RPC per block to retrieve the blockHeader using <code class="vocs_Code">return eth.getBlock(blockNo).then(fromRPC)</code> in function <code class="vocs_Code">getBlockByNumber</code> in <code class="vocs_Code">eth2hmy-relay/getBlockHeader.js</code></li>
</ul>
</li>
<li class="vocs_ListItem">Adding BlockHeaders is done by <code class="vocs_Code">await elc.addBlockHeader(rlpHeader, proofs.dagData, proofs.proofs)</code> which is called from <code class="vocs_Code">cli/ethRelay.js</code>. <code class="vocs_Code">addBlockHeader</code> in <code class="vocs_Code">EthereumLightClient.sol</code>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">calculates the blockHeader Hash</li>
<li class="vocs_ListItem">and checks that it<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">hasn&#x27;t already been relayed,</li>
<li class="vocs_ListItem">is the next block to be added,</li>
<li class="vocs_ListItem">has a valid timestamp</li>
<li class="vocs_ListItem">has a valid difficulty</li>
<li class="vocs_ListItem">has a valid Proof of Work (POW)</li>
</ul>
</li>
<li class="vocs_ListItem">Check if the canonical chain needs to be replaced by another fork</li>
</ul>
</li>
</ol>
<h3 class="vocs_H3 vocs_Heading"><div id="mapping-tokens-ethereum-to-harmony" class="vocs_Heading_slugTarget"></div>Mapping Tokens (Ethereum to Harmony)<a class="vocs_Anchor vocs_Autolink" aria-hidden="true" tabindex="-1" href="/research/code/horizon#mapping-tokens-ethereum-to-harmony" data-discover="true"><div data-autolink-icon="true" class="vocs_Div vocs_AutolinkIcon" style="--vocs_AutolinkIcon_iconUrl:url(/.vocs/icons/link.svg)"></div></a></h3>
<strong class="vocs_Strong">Design</strong>
<ol class="vocs_List vocs_List_ordered">
<li class="vocs_ListItem">If the Token Has not already been mapped on Harmony<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">Harmony: Create an ERC20 Token</li>
<li class="vocs_ListItem">Harmony: Map the Ethereum Token to the new ERC20 Contract</li>
<li class="vocs_ListItem">Ethereum: Validate the Harmony Mapping Transaction</li>
<li class="vocs_ListItem">Ethereum: Map the Harmony ERC20 token to the existing Ethereum Token</li>
<li class="vocs_ListItem">Harmony: Validate the Ethereum mapping Transaction</li>
</ul>
</li>
</ol>
<p class="vocs_Paragraph"><em>Note: The key difference between <code class="vocs_Code">TokenLockerOnEthereum.sol</code> and <code class="vocs_Code">TokenLockerOnHarmony.sol</code> is the proof validation. <code class="vocs_Code">TokenLockerOnEthereum.sol</code> uses <code class="vocs_Code">./lib/MMRVerifier.sol</code> to validate the <a class="vocs_Anchor vocs_Link vocs_Link_accent" href="https://github.com/opentimestamps/opentimestamps-server/blob/master/doc/merkle-mountain-range.mdx" target="_blank" rel="noopener noreferrer" style="--vocs_ExternalLink_iconUrl:url(/.vocs/icons/arrow-diagonal.svg)">Mountain Merkle Ranges</a> on Harmony and <code class="vocs_Code">HarmonyProver.sol</code>. <code class="vocs_Code">TokenLockerOnHarmony.sol</code> imports <code class="vocs_Code">./lib/MPTValidatorV2.sol</code> to validate <a class="vocs_Anchor vocs_Link vocs_Link_accent" href="https://ethereum.org/en/developers/docs/data-structures-and-encoding/patricia-merkle-trie/#merkle-patricia-trees" target="_blank" rel="noopener noreferrer" style="--vocs_ExternalLink_iconUrl:url(/.vocs/icons/arrow-diagonal.svg)">Merkle Patrica Trie</a> and <code class="vocs_Code">./EthereumLightClient.sol</code>.</em></p>
<p class="vocs_Paragraph"><em>Note: <code class="vocs_Code">validateAndExecuteProof</code> is responsible for creation of the BridgeTokens on the destination chain it does this by calling <code class="vocs_Code">execute</code> call in <code class="vocs_Code">TokenLockerLocker.sol</code> which then calls the function <code class="vocs_Code">onTokenMapReqEvent</code> in <code class="vocs_Code">TokenRegistry.sol</code> which creates a new Bridge Token <code class="vocs_Code">BridgedToken mintAddress = new BridgedToken{salt: salt}();</code> and then initializes it. This uses <a class="vocs_Anchor vocs_Link vocs_Link_accent" href="https://ethereum.org/en/developers/docs/data-structures-and-encoding/rlp/" target="_blank" rel="noopener noreferrer" style="--vocs_ExternalLink_iconUrl:url(/.vocs/icons/arrow-diagonal.svg)">(RLP) Serialization</a></em></p>
<p class="vocs_Paragraph"><em>Note: The shims in <code class="vocs_Code">ethWeb3.js</code> provide simplified functions for <code class="vocs_Code">ContractAt</code>, <code class="vocs_Code">ContractDeploy</code>, <code class="vocs_Code">sendTx</code> and <code class="vocs_Code">addPrivateKey</code> and have a constructor which uses <code class="vocs_Code">process.env.PRIVATE_KEY</code>.</em></p>
<strong class="vocs_Strong">Mapping the Tokens</strong>
<div class="vocs_CodeBlock"><div class="vocs_Pre_wrapper"><pre style="background-color:#fff;--shiki-dark-bg:#22272e;color:#24292e;--shiki-dark:#adbac7" tabindex="0" class="shiki shiki-themes github-light github-dark-dimmed vocs_Pre"><button class="vocs_CopyButton" data-copied="false" type="button"><div aria-label="Copy" class="vocs_Icon" role="img" style="--vocs_Icon_size:18px"><svg width="100%" height="100%" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><title>Copy</title><path d="M5 2V1H10V2H5ZM4.75 0C4.33579 0 4 0.335786 4 0.75V1H3.5C2.67157 1 2 1.67157 2 2.5V12.5C2 13.3284 2.67157 14 3.5 14H7V13H3.5C3.22386 13 3 12.7761 3 12.5V2.5C3 2.22386 3.22386 2 3.5 2H4V2.25C4 2.66421 4.33579 3 4.75 3H10.25C10.6642 3 11 2.66421 11 2.25V2H11.5C11.7761 2 12 2.22386 12 2.5V7H13V2.5C13 1.67157 12.3284 1 11.5 1H11V0.75C11 0.335786 10.6642 0 10.25 0H4.75ZM9 8.5C9 8.77614 8.77614 9 8.5 9C8.22386 9 8 8.77614 8 8.5C8 8.22386 8.22386 8 8.5 8C8.77614 8 9 8.22386 9 8.5ZM10.5 9C10.7761 9 11 8.77614 11 8.5C11 8.22386 10.7761 8 10.5 8C10.2239 8 10 8.22386 10 8.5C10 8.77614 10.2239 9 10.5 9ZM13 8.5C13 8.77614 12.7761 9 12.5 9C12.2239 9 12 8.77614 12 8.5C12 8.22386 12.2239 8 12.5 8C12.7761 8 13 8.22386 13 8.5ZM14.5 9C14.7761 9 15 8.77614 15 8.5C15 8.22386 14.7761 8 14.5 8C14.2239 8 14 8.22386 14 8.5C14 8.77614 14.2239 9 14.5 9ZM15 10.5C15 10.7761 14.7761 11 14.5 11C14.2239 11 14 10.7761 14 10.5C14 10.2239 14.2239 10 14.5 10C14.7761 10 15 10.2239 15 10.5ZM14.5 13C14.7761 13 15 12.7761 15 12.5C15 12.2239 14.7761 12 14.5 12C14.2239 12 14 12.2239 14 12.5C14 12.7761 14.2239 13 14.5 13ZM14.5 15C14.7761 15 15 14.7761 15 14.5C15 14.2239 14.7761 14 14.5 14C14.2239 14 14 14.2239 14 14.5C14 14.7761 14.2239 15 14.5 15ZM8.5 11C8.77614 11 9 10.7761 9 10.5C9 10.2239 8.77614 10 8.5 10C8.22386 10 8 10.2239 8 10.5C8 10.7761 8.22386 11 8.5 11ZM9 12.5C9 12.7761 8.77614 13 8.5 13C8.22386 13 8 12.7761 8 12.5C8 12.2239 8.22386 12 8.5 12C8.77614 12 9 12.2239 9 12.5ZM8.5 15C8.77614 15 9 14.7761 9 14.5C9 14.2239 8.77614 14 8.5 14C8.22386 14 8 14.2239 8 14.5C8 14.7761 8.22386 15 8.5 15ZM11 14.5C11 14.7761 10.7761 15 10.5 15C10.2239 15 10 14.7761 10 14.5C10 14.2239 10.2239 14 10.5 14C10.7761 14 11 14.2239 11 14.5ZM12.5 15C12.7761 15 13 14.7761 13 14.5C13 14.2239 12.7761 14 12.5 14C12.2239 14 12 14.2239 12 14.5C12 14.7761 12.2239 15 12.5 15Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg></div></button><code class="vocs_Code"><span class="line vocs_Span"><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span"># Map the Tokens</span></span>
<span class="line vocs_Span"><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span"># map &lt;</span><span style="color:#22863A;font-weight:bold;--shiki-dark:#8DDB8C;--shiki-dark-font-weight:bold" class="vocs_Span">ethUrl</span><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span">&gt; &lt;</span><span style="color:#22863A;font-weight:bold;--shiki-dark:#8DDB8C;--shiki-dark-font-weight:bold" class="vocs_Span">ethBridge</span><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span">&gt; &lt;</span><span style="color:#22863A;font-weight:bold;--shiki-dark:#8DDB8C;--shiki-dark-font-weight:bold" class="vocs_Span">hmyUrl</span><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span">&gt; &lt;</span><span style="color:#22863A;font-weight:bold;--shiki-dark:#8DDB8C;--shiki-dark-font-weight:bold" class="vocs_Span">hmyBridge</span><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span">&gt; &lt;</span><span style="color:#22863A;font-weight:bold;--shiki-dark:#8DDB8C;--shiki-dark-font-weight:bold" class="vocs_Span">token</span><span style="color:#005CC5;font-weight:bold;--shiki-dark:#6CB6FF;--shiki-dark-font-weight:bold" class="vocs_Span">&gt;</span></span>
<span class="line vocs_Span"><span style="color:#24292E;--shiki-dark:#ADBAC7" class="vocs_Span">yarn cli Bridge map http://localhost:8645 0x017f8C7d1Cb04dE974B8aC1a6B8d3d74bC74E7E1 http://localhost:9500 0x017f8C7d1Cb04dE974B8aC1a6B8d3d74bC74E7E1 0x4e59AeD3aCbb0cb66AF94E893BEE7df8B414dAB1</span></span></code></pre></div></div>
<strong class="vocs_Strong">Implementation</strong>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">The CLI calls <code class="vocs_Code">tokenMap</code> in <code class="vocs_Code">src/bridge/contract.js</code> to<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">Instantiate the Ethereum Bridge and Harmony Bridge Contracts</li>
<li class="vocs_ListItem">Calls <code class="vocs_Code">TokenMap</code> in <code class="vocs_Code">scr/bridge/bridge.js</code> to<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">Issue a token Map request on Ethereum <code class="vocs_Code">const mapReq = await src.IssueTokenMapReq(token)</code></li>
<li class="vocs_ListItem">Acknowledge the Map Request on Harmony <code class="vocs_Code">const mapAck = await Bridge.CrossRelayEthHmy(src, dest, mapReq)</code></li>
<li class="vocs_ListItem">Issue a token Map request on Harmony <code class="vocs_Code">return Bridge.CrossRelayHmyEth(dest, src, mapAck.transactionHash)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<strong class="vocs_Strong">Here is the Logic (call execution overview) when Mapping Tokens across Chains. <em>NOTE: Currently mapping has only been developed from Ethereum to Harmony (not bi-directional)</em>.</strong>
<ol class="vocs_List vocs_List_ordered">
<li class="vocs_ListItem">Bridge Map is called in src.cli.index.js and it calls <code class="vocs_Code">tokenMap</code> in <code class="vocs_Code">bridge/contract.js</code> which<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">Get srcBridge Contract on Ethereum <code class="vocs_Code">TokenLockerOnEthereum.sol</code> from <code class="vocs_Code">ethBridge.js</code> it also instantiates an <code class="vocs_Code">eprover</code> using <code class="vocs_Code">tools/eprover/index.js</code> which calls <code class="vocs_Code">txProof.js</code> which uses <a class="vocs_Anchor vocs_Link vocs_Link_accent" href="https://www.npmjs.com/package/eth-proof" target="_blank" rel="noopener noreferrer" style="--vocs_ExternalLink_iconUrl:url(/.vocs/icons/arrow-diagonal.svg)">eth-proof npm package</a>. <em>Note: this is marked with a //TODO need to test and develop proving logic on Harmony.</em></li>
<li class="vocs_ListItem">Get destBridge Contract on Hamony <code class="vocs_Code">TokenLockerOnHarmony.sol</code> from <code class="vocs_Code">hmyBridge.js</code> it also instantiates an <code class="vocs_Code">hprove</code> using <code class="vocs_Code">tools/eprover/index.js</code> which calls <code class="vocs_Code">txProof.js</code> which uses <a class="vocs_Anchor vocs_Link vocs_Link_accent" href="https://www.npmjs.com/package/eth-proof" target="_blank" rel="noopener noreferrer" style="--vocs_ExternalLink_iconUrl:url(/.vocs/icons/arrow-diagonal.svg)">eth-proof npm package</a>.</li>
<li class="vocs_ListItem">calls <code class="vocs_Code">TokenMap</code> in <code class="vocs_Code">bridge.js</code></li>
</ul>
</li>
<li class="vocs_ListItem"><code class="vocs_Code">TokenMap</code> Calls IssueTokenMapReq (on the Ethreum Locker) returning the <code class="vocs_Code">mapReq.transactionHash</code>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem"><code class="vocs_Code">IssueTokenMapReq(token)</code> is held in <code class="vocs_Code">bridge.js</code> as part of the bridge class</li>
<li class="vocs_ListItem">It calls <code class="vocs_Code">issueTokenMapReq</code> on <code class="vocs_Code">TokenLockerOnEthereum.sol</code> which is implemented by <code class="vocs_Code">TokenRegistry.sol</code></li>
<li class="vocs_ListItem"><code class="vocs_Code">issueTokenMapReq</code> checks if the token has already been mapped if not it was emitting a <code class="vocs_Code">TokenMapReq</code> with the details of the token to be mapped. However this was commented out as it was felt that, if it has not been mapped, we use the <code class="vocs_Code">transactionHash</code> of the mapping request` to drive the logic below (not the event).</li>
</ul>
</li>
<li class="vocs_ListItem"><code class="vocs_Code">TokenMap</code> calls <code class="vocs_Code">Bridge.CrossRelay</code> with the IssueTokenMapReq.hash to<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">gets the proof of the transaction on Ethereum via <code class="vocs_Code">getProof</code> calling <code class="vocs_Code">prover.ReceiptProof</code> which calls the eprover and returns <code class="vocs_Code">proof</code> with<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem"><code class="vocs_Code">hash: sha3(resp.header.serialize()),</code></li>
<li class="vocs_ListItem"><code class="vocs_Code">root: resp.header.receiptRoot,</code></li>
<li class="vocs_ListItem"><code class="vocs_Code">proof: encode(resp.receiptProof),</code></li>
<li class="vocs_ListItem"><code class="vocs_Code">key: encode(Number(resp.txIndex)) // &#x27;0x12&#x27; =&gt; Nunmber</code></li>
</ul>
</li>
<li class="vocs_ListItem">We then call <code class="vocs_Code">dest.ExecProof(proof)</code> to execute the proof on Harmony<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">This calls <code class="vocs_Code">validateAndExecuteProof</code> on <code class="vocs_Code">TokenLockerOnHarmony.sol</code> with the <code class="vocs_Code">proofData</code> from above, which<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">requires <code class="vocs_Code">lightclient.VerifyReceiptsHash(blockHash, rootHash),</code> implemented by <code class="vocs_Code">./EthereumLightClient.sol</code>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">This returns <code class="vocs_Code">return bytes32(blocks[uint256(blockHash)].receiptsRoot) == receiptsHash;</code></li>
<li class="vocs_ListItem">
<strong class="vocs_Strong">Which means the block has to be relayed first, as we have just executed the transaction the relayer usually has not relayed the block so this will fail</strong>
</li>
</ul>
</li>
<li class="vocs_ListItem">requires <code class="vocs_Code">lightclient.isVerified(uint256(blockHash)</code> implemented by <code class="vocs_Code">./EthereumLightClient.sol</code>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">This returns <code class="vocs_Code">return canonicalBlocks[blockHash] &amp;&amp; blocks[blockHash].number + 25 &lt; blocks[canonicalHead].number;</code></li>
<li class="vocs_ListItem">
<strong class="vocs_Strong">Which means there must be an additional 25 blocks on Ethereum before this can be processed. This logic needs to be rewritten to break down execution for 1. the ethereum mapping request 2. After a 25 block delay the Harmony Proof validation and executing the Harmony Mapping Request</strong>
</li>
</ul>
</li>
<li class="vocs_ListItem"><code class="vocs_Code">require(spentReceipt[receiptHash] == false, &quot;double spent!&quot;);</code> to ensure that we haven&#x27;t already executed this proof</li>
<li class="vocs_ListItem">gets the <code class="vocs_Code">rlpdata</code> using <code class="vocs_Code">EthereumProver.validateMPTProof</code> implemented by <code class="vocs_Code">EthereumProver.sol</code> which<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">Validates a Merkle-Patricia-Trie proof.</li>
<li class="vocs_ListItem">Returns a value whose inclusion is proved or an empty byte array for a proof of exclusion</li>
</ul>
</li>
<li class="vocs_ListItem">marks <code class="vocs_Code">spentReceipt[receiptHash] = true;</code></li>
<li class="vocs_ListItem"><code class="vocs_Code">execute(rlpdata)</code> implemented by <code class="vocs_Code">TokenLocker.sol</code> which calls <code class="vocs_Code">onTokenMapReqEvent(topics, Data)</code> implemented by <code class="vocs_Code">TokenRegistry.sol</code>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem"><code class="vocs_Code">address tokenReq = address(uint160(uint256(topics[1])));</code> gets the address of the token to be mapped.</li>
<li class="vocs_ListItem">require <code class="vocs_Code">address(RxMapped[tokenReq]) == address(0)</code> that the token has not already been mapped.</li>
<li class="vocs_ListItem"><code class="vocs_Code">address(RxMapped[tokenReq]) == address(0)</code> creates a new BridgedToken implemented by <code class="vocs_Code">BridgedToken.sol</code>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem"><code class="vocs_Code">contract BridgedToken is ERC20Upgradeable, ERC20BurnableUpgradeable, OwnableUpgradeable</code> it is a standard openzepplin ERC20 Burnable, Ownable, Upgradeable token</li>
</ul>
</li>
<li class="vocs_ListItem"><code class="vocs_Code">mintAddress.initialize</code> initialize the token with the same <code class="vocs_Code">name</code>, <code class="vocs_Code">symbol</code> and <code class="vocs_Code">decimals</code> as the ethereum bridged token</li>
<li class="vocs_ListItem"><code class="vocs_Code">RxMappedInv[address(mintAddress)] = tokenReq;</code> updates the inverse Key Value Mapping</li>
<li class="vocs_ListItem"><code class="vocs_Code">RxMapped[tokenReq] = mintAddress;</code> updates the Ethereum mapped tokens</li>
<li class="vocs_ListItem"><code class="vocs_Code">RxTokens.push(mintAddress);</code> add the newly created token to a list of bridged tokens</li>
<li class="vocs_ListItem"><code class="vocs_Code">emit TokenMapAck(tokenReq, address(mintAddress));</code></li>
</ul>
</li>
<li class="vocs_ListItem"><code class="vocs_Code">require(executedEvents &gt; 0, &quot;no valid event&quot;)</code> to check if it executed the mapping correctly.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="vocs_ListItem">We then take the Harmony Mapping <code class="vocs_Code">transactionHash</code> and repeat the above process to prove the Harmony mapping acknowledgment on Ethereum (Cross Relay second call) <code class="vocs_Code">return Bridge.CrossRelay(dest, src, mapAck.transactionHash);</code></li>
</ol>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">gets the proof of the transaction on Harmony via <code class="vocs_Code">getProof</code> calling <code class="vocs_Code">prover.ReceiptProof</code> which calls the eprover and returns <code class="vocs_Code">proof</code> with
_<code class="vocs_Code">hash: sha3(resp.header.serialize()),</code>
_ <code class="vocs_Code">root: resp.header.receiptRoot,</code>
_<code class="vocs_Code">proof: encode(resp.receiptProof),</code>
_ <code class="vocs_Code">key: encode(Number(resp.txIndex)) // &#x27;0x12&#x27; =&gt; Nunmber</code>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">We then call <code class="vocs_Code">dest.ExecProof(proof)</code> to execute the proof on Ethereum<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">This calls <code class="vocs_Code">validateAndExecuteProof</code> on <code class="vocs_Code">TokenLokerOnEthereum.sol</code> with the <code class="vocs_Code">proofData</code> from above, which<!-- -->
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem"><code class="vocs_Code">require(lightclient.isValidCheckPoint(header.epoch, mmrProof.root),</code> implemented by <code class="vocs_Code">HarmonyLightClient.sol</code>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem"><code class="vocs_Code">return epochMmrRoots[epoch][mmrRoot]</code> which means that the epoch has to have had a checkpoint submitted via <code class="vocs_Code">submitCheckpoint</code></li>
</ul>
</li>
<li class="vocs_ListItem"><code class="vocs_Code">bytes32 blockHash = HarmonyParser.getBlockHash(header);</code> gets the blockHash implemented by <code class="vocs_Code">HarmonyParser.sol</code>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem">This returns <code class="vocs_Code">return keccak256(getBlockRlpData(header));</code></li>
<li class="vocs_ListItem"><code class="vocs_Code">getBlockRlpData</code> creates a list <code class="vocs_Code">bytes[] memory list = new bytes[](15);</code> and uses statements like <code class="vocs_Code">list[0] = RLPEncode.encodeBytes(abi.encodePacked(header.parentHash));</code> to perform <a class="vocs_Anchor vocs_Link vocs_Link_accent" href="https://ethereum.org/en/developers/docs/data-structures-and-encoding/rlp/" target="_blank" rel="noopener noreferrer" style="--vocs_ExternalLink_iconUrl:url(/.vocs/icons/arrow-diagonal.svg)">Recursive-Length Prefix (RLP) Serialization</a> implemented by <code class="vocs_Code">RLPEncode.sol</code></li>
</ul>
</li>
<li class="vocs_ListItem"><code class="vocs_Code">HarmonyProver.verifyHeader(header, mmrProof);</code> verifys the header implemented by <code class="vocs_Code">HarmonyProver.sol</code>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem"><code class="vocs_Code">bytes32 blockHash = HarmonyParser.getBlockHash(header);</code> gets the blockHash implemented by <code class="vocs_Code">HarmonyParser.sol</code> as above</li>
<li class="vocs_ListItem"><code class="vocs_Code">valid = MMRVerifier.inclusionProof(proof.root, proof.width, proof.index, blockHash, proof.peaks, proof.siblings);</code> verifys the proff using the <a class="vocs_Anchor vocs_Link vocs_Link_accent" href="https://github.com/opentimestamps/opentimestamps-server/blob/master/doc/merkle-mountain-range.mdx" target="_blank" rel="noopener noreferrer" style="--vocs_ExternalLink_iconUrl:url(/.vocs/icons/arrow-diagonal.svg)">Merkle Mountain Range Proof</a> passed <code class="vocs_Code">MMRVerifier.MMRProof memory proof</code> and the <code class="vocs_Code">blockHash</code>.</li>
<li class="vocs_ListItem">
<strong class="vocs_Strong">NOTE: This means that a <code class="vocs_Code">submitCheckpoint</code> in <code class="vocs_Code">HarmonyLightClient.sol</code> needs to have called either for the next epoch or for a checkpoint, after the block the harmony mapping transaction was in.</strong>
</li>
<li class="vocs_ListItem">
<strong class="vocs_Strong">NOTE: Automatic submission of checkpoints to the Harmony Light Client has not been developed as yet. (It is not part of the <code class="vocs_Code">ethRelay.js</code>). And so the checkpoint would need to be manually submitted before the Ethereum Mapping could take place.</strong>
</li>
</ul>
</li>
<li class="vocs_ListItem"><code class="vocs_Code">require(spentReceipt[receiptHash] == false, &quot;double spent!&quot;);</code> ensure that we haven&#x27;t already processed this mapping request`</li>
<li class="vocs_ListItem"><code class="vocs_Code">HarmonyProver.verifyReceipt(header, receiptdata)</code> ensure the receiptdata is valid</li>
<li class="vocs_ListItem"><code class="vocs_Code">spentReceipt[receiptHash] = true;</code> marks the receipt as having been processed</li>
<li class="vocs_ListItem"><code class="vocs_Code">execute(receiptdata.expectedValue);</code> implemented by <code class="vocs_Code">TokenLocker.sol</code> which calls <code class="vocs_Code">onTokenMapAckEvent(topics)</code> implemented by <code class="vocs_Code">TokenRegistry.sol</code>
<ul class="vocs_List vocs_List_unordered">
<li class="vocs_ListItem"><code class="vocs_Code">address tokenReq = address(uint160(uint256(topics[1])));</code></li>
<li class="vocs_ListItem"><code class="vocs_Code">address tokenAck = address(uint160(uint256(topics[2])));</code></li>
<li class="vocs_ListItem"><code class="vocs_Code">require(TxMapped[tokenReq] == address(0), &quot;missing mapping to acknowledge&quot;);</code></li>
<li class="vocs_ListItem"><code class="vocs_Code">TxMapped[tokenReq] = tokenAck;</code></li>
<li class="vocs_ListItem"><code class="vocs_Code">TxMappedInv[tokenAck] = IERC20Upgradeable(tokenReq);</code></li>
<li class="vocs_ListItem"><code class="vocs_Code">TxTokens.push(IERC20Upgradeable(tokenReq));</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="5" class="vocs_List vocs_List_ordered">
<li class="vocs_ListItem">Upon completion of tokenMap control is passed back to Bridge Map which</li>
<li class="vocs_ListItem">Calls TokenPair on Ethereum</li>
<li class="vocs_ListItem">Calls ethTokenInfo to get the status of the ERC20</li>
<li class="vocs_ListItem">Calls hmyTokenInfo to get the tokenStatus on Harmony</li>
</ol></article><footer class="vocs_Footer" data-layout="docs"><div class="vocs_Footer_container"></div><div><center><p><a href="https://meet.johnwhitton.com">Meet with John</a></p><p class="copyright">John Whitton.<!-- --> <a href="mailto:john@johnwhitton.com">john@johnwhitton.com</a></p><p class="copyright">© John Whitton. Design:<!-- --> <a href="https://html5up.net">HTML5 UP</a>.</p></center></div></footer></div><div data-bottom-observer="true"></div></div></div>
  </body>
</html>
